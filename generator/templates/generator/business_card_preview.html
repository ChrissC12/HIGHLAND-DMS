{% extends "base.html" %}
{% load static %}

{% block title %}Business Card Preview for {{ employee.full_name }}{% endblock %}

{% block extra_css %}
<!-- =================================================================== -->
<!-- STYLES FOR THE FINAL, RESTRUCTURED 2-SIDED BUSINESS CARD -->
<!-- =================================================================== -->
<style>
    :root {
        --hc-white: #FFFFFF;
        --hc-gold: #D4AF37;
        --hc-red: #C0392B;
        --hc-dark: #2C3E50;
        --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
        --hover-effect: translateY(-5px);
    }
    
    .preview-page-container { 
        background-color: #f8f9fa; 
        padding: 2rem; 
        border-radius: 10px; 
    }
    
    .preview-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        gap: 30px;
        padding: 40px 0;
    }
    
    .business-card {
        width: 3.5in;
        height: 2in;
        box-shadow: var(--card-shadow);
        border-radius: 8px;
        overflow: hidden;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        transition: transform 0.3s ease-in-out;
        position: relative;
    }
    
    .business-card:hover {
        transform: var(--hover-effect);
    }

    .business-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        z-index: 0;
        pointer-events: none;
    }

    /* --- RESTRUCTURED FRONT SIDE STYLING --- */
    .business-card--front {
        background: var(--hc-white);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        position: relative;
        z-index: 1;
        width: 100%;
        height: 100%;
    }
    .front__logo-area {
        flex-shrink: 0;
        text-align: center;
    }
    .front__logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    .front__separator {
        width: 2px;
        height: 60%;
        background-color: var(--hc-gold);
    }
    .front__main-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .front__employee-name {
        font-size: 24px;
        font-weight: 700;
        color: var(--hc-dark);
        margin: 0;
    }
    .front__employee-title {
        font-size: 16px;
        color: var(--hc-red);
        margin: 2px 0 15px 0;
    }
    .front__contact-info {
        font-size: 11px;
        line-height: 1.8;
        color: #555;
    }
    .front__contact-info strong {
        color: var(--hc-dark);
    }
    
    /* ============================================= */
    /* --- RESTRUCTURED BACK SIDE STYLING --- */
    /* ============================================= */
    .business-card--back {
        background: var(--hc-dark);
        color: var(--hc-white);
        display: flex;
        padding: 20px;
        position: relative;
        z-index: 1;
        width: 100%;
        height: 100%;
    }
    
    .back__left-col {
        flex: 0 0 60%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .back__right-col {
        flex: 0 0 40%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-left: 1px solid var(--hc-gold);
        padding-left: 15px;
    }
    
    .back__logo-area {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .back__logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
    }
    
    .back__company-name {
        font-size: 14px;
        font-weight: bold;
        color: var(--hc-white);
        margin: 0;
    }
    
    .back__tagline {
        font-size: 10px;
        font-style: italic;
        color: var(--hc-gold);
        margin-bottom: 15px;
    }
    
    .back__contact-details {
        font-size: 9px;
        line-height: 1.6;
    }
    
    .back__contact-details p {
        margin: 4px 0;
    }
    
    .back__contact-details strong {
        color: var(--hc-gold);
        margin-right: 5px;
    }
    
    .back__qr-code {
        width: 80px;
        height: 80px;
        background: white;
        padding: 5px;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .back__website {
        font-size: 9px;
        color: var(--hc-white);
        text-align: center;
        margin: 5px 0;
    }
    
    .back__social-icons {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 5px;
    }
    
    .back__social-link {
        color: var(--hc-white);
        text-decoration: none;
        font-size: 12px;
        opacity: 0.8;
        transition: opacity 0.3s;
    }
    
    .back__social-link:hover {
        opacity: 1;
        color: var(--hc-gold);
    }
    
    /* Action panel styling */
    .action-panel { position: sticky; top: 100px; }
    .action-panel__title { font-weight: bold; }
    .action-panel__description { font-size: 0.9rem; color: #6c757d; }
    
    @media (max-width: 992px) {
        .preview-container { flex-direction: column; align-items: center; }
        .action-panel { position: static; margin-top: 2rem; }
    }
</style>
{% endblock %}


{% block content %}
<div class="preview-page-container">
    <div class="row">
        <!-- Preview Section -->
        <div class="col-lg-8">
            <header class="preview-header text-center mb-4">
                <h4 class="fw-bold">Business Card Preview</h4>
                <p class="text-muted">This is a live preview of the business card, front and back.</p>
            </header>
            
            <div class="preview-container">
                <!-- ============================================= -->
                <!-- RESTRUCTURED FRONT CARD -->
                <!-- ============================================= -->
                <article class="business-card" id="business-card-front">
                    <div class="business-card--front">
                        <div class="front__logo-area">
                            {% if company_info.logo_thumbnail %}
                            <img src="{{ company_info.logo_thumbnail.url }}" alt="{{ company_info.name }} Logo" class="front__logo">
                            {% else %}
                            <div class="front__logo" style="background:#eee; border:1px solid #ccc;"></div>
                            {% endif %}
                        </div>
                        
                        <div class="front__separator"></div>
                        
                        <div class="front__main-info">
                            <h1 class="front__employee-name">{{ employee.full_name }}</h1>
                            <p class="front__employee-title">Position: {{ employee.job_title }}</p>
                            
                            <address class="front__contact-info" style="font-style: normal;">
                                <strong>Phone:</strong> {{ card.personal_phone|default:company_info.phone|default:"N/A" }}<br>
                                <strong>Email:</strong> {{ card.personal_email|default:company_info.email|default:"N/A" }}<br>
                                <strong>Website:</strong> {{ card.website_url|default:company_info.website|default:"N/A" }}
                            </address>
                        </div>
                    </div>
                </article>

                <!-- ============================================= -->
                <!-- RESTRUCTURED BACK CARD -->
                <!-- ============================================= -->
                <article class="business-card" id="business-card-back">
                    <div class="business-card--back">
                        <div class="back__left-col">
                            <div>
                                <div class="back__logo-area">
                                    {% if company_info.logo_thumbnail %}
                                    <img src="{{ company_info.logo_thumbnail.url }}" alt="{{ company_info.name }} Logo" class="back__logo">
                                    {% endif %}
                                    <h3 class="back__company-name">{{ company_info.name }}</h3>
                                </div>
                                
                                {% if company_info.tagline %}
                                <p class="back__tagline">"{{ company_info.tagline }}"</p>
                                {% endif %}
                                
                                <div class="back__contact-details">
                                    <p><strong>Address:</strong> {{ company_info.address|default:"N/A" }}</p>
                                    <p><strong>Phone:</strong> {{ company_info.phone|default:"N/A" }}</p>
                                    <p><strong>Email:</strong> {{ company_info.email|default:"N/A" }}</p>
                                    <p><strong>Website:</strong> {{ company_info.website|default:"N/A" }}</p>
                                </div>
                            </div>
                            
                            <div class="back__social-icons">
                                {% if company_info.linkedin_url %}
                                <a href="{{ company_info.linkedin_url }}" target="_blank" class="back__social-link">
                                    <i class="fab fa-linkedin"></i>
                                </a>
                                {% endif %}
                                {% if company_info.instagram_url %}
                                <a href="{{ company_info.instagram_url }}" target="_blank" class="back__social-link">
                                    <i class="fab fa-instagram"></i>
                                </a>
                                {% endif %}
                                {% if company_info.facebook_url %}
                                <a href="{{ company_info.facebook_url }}" target="_blank" class="back__social-link">
                                    <i class="fab fa-facebook"></i>
                                </a>
                                {% endif %}
                                {% if company_info.twitter_url %}
                                <a href="{{ company_info.twitter_url }}" target="_blank" class="back__social-link">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="back__right-col">
                            {% if employee.qr_code %}
                            <img src="{{ employee.qr_code.url }}" alt="QR Code" class="back__qr-code">
                            {% else %}
                            <div class="back__qr-code" style="background:#eee; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #666; font-size: 8px;">QR Code</span>
                            </div>
                            {% endif %}
                            
                            {% if company_info.website %}
                            <p class="back__website">{{ company_info.website }}</p>
                            {% endif %}
                            
                            <p style="font-size: 9px; color: var(--hc-gold); text-align: center; margin: 0;">
                                Scan to save contact
                            </p>
                        </div>
                    </div>
                </article>
            </div>
        </div>
        
        <!-- Actions Panel -->
        <div class="col-lg-4">
            <aside class="card border-0 shadow-sm action-panel">
                <div class="card-body">
                    <h5 class="card-title action-panel__title">Actions</h5>
                    <p class="card-text action-panel__description">
                        Download high-resolution images of the business card, suitable for printing.
                    </p>
                    <div class="d-grid gap-2">
                        <!-- ============================================= -->
                        <!-- NEW PRINT BUTTON -->
                        <!-- ============================================= -->
                        <a href="{% url 'generator:business_card_print' employee.id %}" target="_blank" class="btn btn-danger text-white">
                            <i class="fas fa-print me-2"></i>Print Business Card
                        </a>
                        <!-- Keep download buttons as a secondary option 
                        <button class="btn btn-outline-secondary" id="download-front-btn">Download Front (PNG)</button>
                        <button class="btn btn-outline-secondary" id="download-back-btn">Download Back (PNG)</button>
                        -->
                    </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Download function for business cards
    function downloadCard(elementId, filename) {
        const element = document.getElementById(elementId);
        if (element) {
            html2canvas(element, { 
                scale: 4,
                useCORS: true,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error('Error generating card image:', error);
                alert('Failed to generate download. Please try again.');
            });
        }
    }

    // Event listeners for download buttons
    document.getElementById('download-front-btn').addEventListener('click', function() {
        downloadCard('business-card-front', 'Highland_BizCard_{{ employee.employee_id }}_Front.png');
    });
    
    document.getElementById('download-back-btn').addEventListener('click', function() {
        downloadCard('business-card-back', 'Highland_BizCard_{{ employee.employee_id }}_Back.png');
    });
});
</script>
{% endblock %}